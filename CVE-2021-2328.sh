#!/usr/bin/bash
. ./oracle_param.ini
################################################################################
#                       CVE-2021-2328
#
#                    Prior to 21.1.0.00.01
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-2328
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################


discover_2328_1(){
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT count(*) FROM   ctxsys.ctx_indexes where idx_owner<>'CTXSYS';
EOM
)
 if [ ${#val1} > 0 ]
 then
  echo "${val1}"
  discover_2328_1_return=1
 else
  discover_2328_1_return=0
 fi
  return "$discover_2328_1_return"
}

discover_2328_2(){
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select  detected_usages from DBA_FEATURE_USAGE_STATISTICS where name like '%Text%' ;
EOM
)
 if [ ${#val1} > 0 ]
 then
  echo "${val1}"
  discover_2328_2_return=1
 else
  discover_2328_2_return=0
 fi
  return "$discover_2328_2_return"
}

mitigate_2328_1(){
 echo "Commands to Revoke 'CREATE ANY PROCEDURE','ALTER ANY TABLE' privilege, spool file created as CVE-2021-2328_1.sql"
 sqlplus -s / as sysdba<<EOM
        set heading OFF termout ON trimout ON feedback OFF
        set pagesize 0
        spool CVE-2021-2328_1.sql
        SELECT 'REVOKE CREATE ANY PROCEDURE, ANTER ANY TABLE FROM '|| GRANTEE ||';' FROM DBA_SYS_PRIVS WHERE PRIVILEGE IN ('CREATE ANY PROCEDURE','ALTER ANY TABLE') AND GRANTEE NOT IN ('DBA','SYS','SYSTEM');
        spool off;
EOM
}

mitigate_2328_2(){
 echo "For Oracle Database Versions before 12c it is recommended that CTXSYS is un-installed to reduce the attack surface."
 echo "For Oracle Database Versions on or after 12c, the Oracle Text component cannot be removed from the database due to the multitenant architecture of container and pluggable databases."
 echo "Execute the following command to expire the password for ctxsys account:"
 echo "alter user ctxsys account lock password expire;"
}

discover_2328_1_return=$?
discover_2328_2_return=$?

discover_2328_1
discover_2328_2
if [ "$discover_2328_1_return" == 1 ] || [ "$discover_2328_2_return" == 1 ]
then
    mitigate_2328_1
    mitigate_2328_2
fi
## main ###
