#!/usr/bin/bash
#. ./oracle_param.ini
################################################################################
#                               CVE-2021-35551
#                               CVE-2021-35557
#                               CVE-2021-35558
#                         12.1.0.2, 12.2.0.1, 19c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-35551.sh
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################

# export ORACLE_BASE=/u01/app/oracle
# export ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# export ORACLE_SID=orclcdb
# export SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus
# export ORACLE_HOME=$PATH:$ORACLE_HOM/bin

#./CVE-2021-35551-cdb.sh ORCL,ORCL

discover_35551_1(){
discover_35551_1_return=0
 val2=`grep -ioh "tcp.validnode_checking" $ORACLE_HOME/network/admin/sqlnet.ora`
 #echo "${val2}"
  if [ "${val2}" = "tcp.validnode_checking" ]
  then
    discover_35551_1_return=1
   else
    discover_35551_1_return=0
  fi
  return "$discover_35551_1_return"
}

discover_35551_2(){
discover_35551_2_return=0
 val2=`grep -ioh "tcp.invited_nodes" $ORACLE_HOME/network/admin/sqlnet.ora`
 #echo "${val2}"
  if [ "${val2}" = "tcp.invited_nodes" ]
  then
    discover_35551_2_return=1
   else
    discover_35551_2_return=0
  fi
  return "$discover_35551_2_return"
}

discover_35551_3(){
#SQL 4
val1=$(sqlplus -s / as sysdba<<EOM
alter session set container=$1;
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT UPPER(VALUE) "PARAMETER" FROM V\$PARAMETER WHERE UPPER(NAME) = 'REMOTE_LOGIN_PASSWORDFILE';
EOM
)
 if [[ ${val1} == *"SHARED"* ]]
 then
  discover_35551_3_return=1
 else
  discover_35551_3_return=0
  # It should be NONE or EXCLUSIVE  https://docs.oracle.com/database/121/REFRN/GUID-6619299E-95E8-4821-B123-3B5899F046C7.htm#REFRN10184
 fi
  return "$discover_35551_3_return"
}

mitigate_35551_1(){
# CVE-2021-35551 SQL# 2 3 3B 4
# CVE-2021-35557 SQL#1
echo "Mitigate CVE-2021-35551 #1 "
echo "please review commands in sql file mitigate_35551_1.sql"
sqlplus -s / as sysdba<<EOM
       set heading OFF termout ON trimout ON feedback OFF
       set pagesize 0
       spool mitigate_35551_1_$1\.sql
       select 'REVOKE SYSDBA FROM ' || username || ';' from v\$pwfile_users where username not in ('ANONYMOUS','APEX_050100','APEX_PUBLIC_USER','APPQOSSYS','AUDSYS','CTXSYS','DBSFWUSER','DBSNMP','DIP','DVSYS','DVF','FLOWS_FILES','GGSYS','GSMADMIN_INTERNAL','GSMATUSER','GSMUSER','HR','LBACSYS','MDDATA','MDSYS','OUTLN','ORACLE_OCM','REMOTE_SCHEDULER_AGENT','SYS','SYSTEM','SYSBACKUP','SYSKM','SYSDG','SYSRAC','SYS\$UMF','WMSYS','XDB','XS\$NULL');
       SELECT 'REVOKE ' || GRANTED_ROLE || ' FROM '|| GRANTEE || ';'  FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' and grantee in (select distinct username from dba_users) AND GRANTEE NOT IN ('SYS','SYSTEM');
       SELECT 'REVOKE ' || GRANTED_ROLE || ' FROM ' || ROLE || ';' FROM ROLE_ROLE_PRIVS WHERE GRANTED_ROLE = 'DBA';
       SELECT 'REVOKE ' || GRANTED_ROLE || ' FROM '|| GRANTEE || ';'from dba_role_privs where admin_option = 'YES' and granted_role = 'DBA' and grantee in (select distinct username from dba_users) AND GRANTEE NOT IN ('SYS','SYSTEM');
       select 'REVOKE ' || GRANTED_ROLE || ' FROM ' || ROLE || ';' from role_role_privs where admin_option = 'YES' and granted_role = 'DBA' ;
       SELECT 'REVOKE CREATE TABLE FROM ' || GRANTEE || ';'  FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE TABLE' AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
       spool off;
EOM
}

mitigate_35551_2(){
echo "Mitigate CVE-2021-35551 #2 "
echo "please review recommendation in sql file mitigate_35551_2.txt"
echo "mitigate_35551_2.txt" >  mitigate_35551_2_$1\.sql
echo " "
echo "
As this is RDBMS security issue, all DB's are impacted. Ensure node checking/whitelisting has been configured for Oracle Net Protocol.

This could be verified by reviewing the sqlnet.ora file for parameters mentioned in the example below -

tcp.validnode_checking = yes
tcp.invited_nodes = (hostname1, hostname2)

" >>  mitigate_35551_2_$1\.sql
echo "With GRANT ANY ROLE,GRANT ANY OBJECT PRIVILEGE, GRANT ANY PRIVILEGE, the user who is granted DBA role can grant DBA role to other user. In order to prevent them from granting DBA role to another user, instead of DBA role,
it is recommended to create a custom nole not including these system privileges.

CREATE ROLE RESTRICT_DBA;

GRANT EXP_FULL_DATABASE,DATAPUMP_EXP_FULL_DATABASE,DELETE_CATALOG_ROLE,EXECUTE_CATALOG_ROLE,GATHER_SYSTEM_STATISTICS,JAVA_ADMIN,JAVA_DEPLOY,OLAP_DBA,
OLAP_XS_ADMIN,SCHEDULER_ADMIN,SELECT_CATALOG_ROLE,WM_ADMIN_ROLE,XDBADMIN,XDB_SET_INVOKER TO RESTRICT_DBA;

create user <USERNAME1> identified by <PASSWORD>;
grant RESTRICT_DBA to <USERNAME1>;
" >>  mitigate_35551_2_$1\.sql

}

mitigate_35551_3(){
  echo "Mitigate CVE-2021-35551 #3 "
  echo "please review recommendation in sql file mitigate_35551_3.txt"
  echo "  mitigate_35551_3.txt" >  mitigate_35551_3_$1\.sql
  echo " "
  echo "As password file (orapwd) enables remote users to connect with administrative privileges through SQL*Net,
  The following SQL has returned the value "SHARED"

  SELECT UPPER(VALUE) "PARAMETER"
  FROM V$PARAMETER
  WHERE UPPER(NAME) = 'REMOTE_LOGIN_PASSWORDFILE';

  Please ensure 'REMOTE_LOGIN_PASSWORDFILE' Is Set to 'EXCLUSIVE' or 'NONE'." > mitigate_35551_3_$1\.sql

}



mitigate_35557_1(){
# CVE-2021-35551 SQL# 2 3 3B 4
# CVE-2021-35557 SQL#1
echo "Mitigate CVE-2021-35557 #1 "
echo "please review commands in sql file mitigate_35557_1.sql"
sqlplus -s / as sysdba<<EOM
       alter session set container=$1;
       set heading OFF termout ON trimout ON feedback OFF
       set pagesize 0
       spool mitigate_35557_1_$1\.sql
       SELECT 'REVOKE CREATE TABLE FROM ' || GRANTEE || ';'  FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE TABLE' AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
       spool off;
EOM
}

mitigate_35557_2(){
val1=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0 linesize 120
  alter session set container=$1;
  SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE in ('CREATE TABLE','UNLIMITED TABLESPACE') AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
EOM
)
 if [ ${#val1} > 0 ]
 then
  echo " "
  echo "Mitigate mitigate_35557_2.txt"
  echo "please review recommendation in sql file mitigate_35557_2.txt"
  echo "mitigate_35551_2.txt" >  mitigate_35551_2_$1\.sql
  echo "Here are list of users that have both CREATE TABLE privilege and unrestricted tablespace quotas." >>  mitigate_35551_2_$1\.sql
  echo "${val1}" >>  mitigate_35551_2_$1\.sql
  echo "
  Audit whether user should be allowed to use an unlimited amount of any tablespace in the database, and override all explicit
tablespace quotas for the user. Otherwise introduce quotas.
      " >>  mitigate_35551_2_$1\.sql
 else
   echo " " >  mitigate_35551_2_$1\.sql
   echo "Mitigate mitigate_35557_2.txt" >>  mitigate_35551_2_$1\.sql
   echo "No Action required." >>  mitigate_35551_2_$1\.sql
 fi
}
### main ###
PDB_NAME=$1
for i in `echo "$PDB_NAME" | tr -s ',' ' '`
do
    discover_35551_1 $i
    discover_35551_2 $i
    discover_35551_3 $i

    discover_35551_1_return=$?
    discover_35551_2_return=$?
    discover_35551_3_return=$?

    if [ "$discover_35551_1_return" = 0 ] || [ "$discover_35551_2_return" = 0 ]
    then
       mitigate_35551_1 $i
       mitigate_35551_2 $i
       mitigate_35557_1 $i
       mitigate_35557_2 $i
    fi

    if [ "$discover_35551_3_return" = 1 ]
    then
       mitigate_35551_3 $i
    fi
done
### main ###
