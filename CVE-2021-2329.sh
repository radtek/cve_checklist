#!/usr/bin/bash
#. ./oracle_param.ini
################################################################################
#                       CVE-2021-2329 CVE-2021-2337
#                         12.1.0.2, 12.2.0.1, 19c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-2329.sh
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################

# export ORACLE_BASE=/u01/app/oracle
# export ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# export ORACLE_SID=orclcdb
# export SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus
# export ORACLE_HOME=$PATH:$ORACLE_HOM/bin

discover_2329_1(){
#
# declare in main as: discover_2333_1_return=$?
#
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select status from dba_registry where comp_id='XDB';
EOM
)
  # echo "${val1}"
  if [ "${val1}" = "VALID" ]
   then
     echo "XDB is installed"
     discover_2329_1_return=1
    else
      echo "XDB is not installed"
      discover_2329_1_return=0
   fi
   return "$discover_2329_1_return"
}

mitigate_2329_1(){
 echo " "
 echo "If the Database option "Oracle XDB" is not required for this database, "
 echo "Consider Revoke the system privileges or Remove the XML DB from the database."
 echo "Commands are created in sql script drop_xdb.sql"
 cat "--- The catnoqm.sql script to drops XDB component from the Database." >  drop_xdb.sql
 cat "--- For Clustered Database Run the commands from any one of the node" >> drop_xdb.sql
 cat "spool xdb_removal.log" 												>> drop_xdb.sql
 cat "set echo on;" 														>> drop_xdb.sql
 cat "connect / as sysdba" 													>> drop_xdb.sql
 cat "shutdown immediate;" 													>> drop_xdb.sql
 cat "startup" 																>> drop_xdb.sql
 cat "@?/rdbms/admin/catnoqm.sql" 											>> drop_xdb.sql
 cat "spool off;" 															>> drop_xdb.sql
}

### main ###
ver=$(sqlplus -s / as sysdba <<EOM
      set heading OFF termout ON trimout ON feedback OFF
      set pagesize 0
      select version from v\$instance;
EOM
     )


discover_2329_1_return=$?
discover_2333_1
if [ "$discover_2329_1_return" == 1 ]
then
   mitigate_2329_1
fi

### main ###
