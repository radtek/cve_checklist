#!/usr/bin/bash
. ./oracle_param.ini
################################################################################
#                              CVE-2021-2333
#                         12.1.0.2, 12.2.0.1, 19c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-2333.sh
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################

# export ORACLE_BASE=/u01/app/oracle
# export ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# export ORACLE_SID=orclcdb
# export SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus
# export ORACLE_HOME=$PATH:$ORACLE_HOM/bin

discover_2333_1(){
#
# declare in main as: discover_2333_1_return=$?
#
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select status from dba_registry where comp_id='XDB';
EOM
)
  # echo "${val1}"
  if [ "${val1}" = "VALID" ]
   then
     echo "XDB is installed"
     discover_2333_1_return=1
    else
      echo "XDB is not installed"
      discover_2333_1_return=0
   fi
   return "$discover_2333_1_return"
}

mitigate_2333_1(){
 echo " "
 echo "Following Users have "ALTER USER" privileges and recommended to revoke."
 res1=$(sqlplus -s / as sysdba<<EOM
        set heading OFF termout ON trimout ON feedback OFF
        set pagesize 0
        SELECT 'REVOKE ALTER USER FROM '|| GRANTEE ||';' FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'ALTER USER' AND GRANTEE NOT IN ('SYS','DBA','SYSTEM');
EOM
        )
 echo " " > mitigate_2333_1.sql
 echo "Script to revoke the ALTER USER privilege from the users. " >> mitigate_2333_1.sql
 echo $res1 >> mitigate_2333_1.sql
 echo " " >> mitigate_2333_1.sql
}

### main ###
ver=$(sqlplus -s / as sysdba <<EOM
      set heading OFF termout ON trimout ON feedback OFF
      set pagesize 0
      select version from v\$instance;
EOM
     )

case $ver in
 '19.0.0.0.0'|'12.0.0.0.0')
      discover_2333_1_return=$?
      discover_2333_1
      if [ "$discover_2333_1_return" == 1 ]
      then
         mitigate_2333_1
      fi
      ;;
  *)
       echo "Incompatible Oracle Version"
       ;;
esac
### main ###
