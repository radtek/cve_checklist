#!/usr/bin/bash
. ./oracle_param.ini
################################################################################
#                              CVE-2021-2333                                   
#                         12.1.0.2, 12.2.0.1, 19c                              
# Sample script that checks the DB version and execute a check following       
# by recommendation. 
# Create oracle_param.ini file with defined variables                                                         
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-2330.sh
# 
# Change History                                                               
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating     
#                              new Bash shell scripts.                            
#                              Add new history entries as needed.                 
#                                                                              
#                                                                              
################################################################################
################################################################################

discover_2330_2(){
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE TABLE' and GRANTEE NOT IN ('DBA','SYS','SYSTEM');
EOM
)
 if [ ${#val1} > 0 ]
 then
  echo "Following users have CREATE TABLE privileges, if not necessary please revoke."
  echo "${val1}"
  retval=1
 else
  retval=0
 fi
  return "$retval"
}

discover_2330_2(){
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE TABLE' and GRANTEE NOT IN ('DBA','SYS','SYSTEM');
EOM
)
 if [ ${#val1} > 0 ]
 then
  echo "Following users have CREATE TABLE privileges, if not necessary please revoke."
  echo "${val1}"
  discover_2330_2_return=1
 else
  discover_2330_2_return=0
 fi
  return "$discover_2330_2_return"
}

mitigate_2330_2(){
 echo "Commands to Revoke CREATE TABLE privilege, spool file created as CVE-2021-2330.sql" 
 sqlplus -s / as sysdba<<EOM
        set heading OFF termout ON trimout ON feedback OFF 
        set pagesize 0
        spool CVE-2021-2330.sql
        SELECT 'REVOKE CREATE TABLE FROM '|| GRANTEE ||';' FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE TABLE' AND GRANTEE NOT IN ('SYS','DBA','SYSTEM'); 
        spool off; 
EOM
}
discover_2330_2_return=$?
discover_2330_2
if [ "$discover_2330_2_return" == 1 ]
then
    mitigate_2330_2
fi
## main ###
