#!/usr/bin/bash
#. ./oracle_param.ini
################################################################################
#                              CVE-2021-2332
#                         12.1.0.2, 12.2.0.1, 19c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-2332.sh
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################

# export ORACLE_BASE=/u01/app/oracle
# export ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# export ORACLE_SID=orclcdb
# export SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus
# export ORACLE_HOME=$PATH:$ORACLE_HOM/bin
discover_2332_1(){
discover_2332_1_return=0
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select count(*) from x\$logmnr_session;
EOM
)
 #echo "${val1}"
 if [ "${val1}" > 0  ]
  then
    discover_2332_1_return=1
   else
    discover_2332_1_return=0
  fi
  return "$discover_2332_1_return"
}


discover_2332_2(){
discover_2332_2_return=0
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select sum(cnt) cnt
from ( select count(*) cnt from V\$LOGMNR_DICTIONARY
        union All
select count(*) cnt from V\$LOGMNR_PARAMETERS
        union All
select count(*) cnt from V\$LOGMNR_LOGS
    ) s;
EOM
)
 #echo "${val1}"
 if [ "${val1}" > 0  ]
  then
    discover_2332_2_return=1
   else
    discover_2332_2_return=0
  fi
  return "$discover_2332_2_return"
}


### Mitigate functions
mitigate_2332_1(){
  # SQL#2
  echo "Mitigate #1 "
  echo "1. Vulnerability requires high level DBA privileges with LogMiner packages owned by the SYS schema. Audit access to the Log Miner tables and packages.  "
  echo "â€“ Only authorized administrators should have DBA role access required to exploit vulnerability"
  echo "Please review mitigate_2332_1.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0 linesize 120
         spool mitigate_2332_1.sql
       SELECT 'GRANT' AS PATH, GRANTEE, GRANTED_ROLE
       FROM DBA_ROLE_PRIVS
       WHERE GRANTED_ROLE = 'DBA' AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'))
       UNION
       SELECT 'PROXY', PROXY || '-' || CLIENT, 'DBA'
       FROM DBA_PROXIES
       WHERE CLIENT IN (SELECT GRANTEE FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE = 'DBA');
         spool off;
EOM
}

mitigate_2332_2(){
  # SQL#3,4
  echo "Mitigate #2 "
  echo "2. Review Granted Privileges on Sensitive Log Miner Tables/Views "
  echo "Check Execute Privileges on Log Miner Packages"
  echo "Please review mitigate_2332_2.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0 linesize 120
         spool mitigate_2332_2.sql
         SELECT 'REVOKE '||  PRIVILEGE || ' ON ' || TABLE_NAME  || ' FROM ' ||GRANTEE || ';' FROM DBA_TAB_PRIVS WHERE TABLE_NAME  like '%V%LOGMNR%' AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'))
         UNION
         SELECT 'REVOKE '||  PRIVILEGE || ' ON ' || TABLE_NAME  || ' FROM ' ||GRANTEE || ';' FROM DBA_TAB_PRIVS WHERE PRIVILEGE = 'EXECUTE' AND TABLE_NAME  like '%V%LOGMNR%' AND GRANTEE IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
         spool off;
EOM
}

discover_2332_3(){
discover_2332_1_return=0
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select value from v\$parameter where lower(name)='utl_file_dir';
EOM
)
 #echo "${val1}"
 if [ "${val1}" > 0  ]
  then
    discover_2332_3_return=1
   else
    discover_2332_3_return=0
  fi
  return "$discover_2332_3_return"
}

discover_2332_4(){
discover_2332_4_return=0
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT count(*) FROM V\$LOGMNR_CONTENTS;
EOM
)
 #echo "${val1}"
 if [ "${val1}" > 0  ]
  then
    discover_2332_4_return=1
   else
    discover_2332_4_return=0
  fi
  return "$discover_2332_4_return"
}


mitigate_2332_3(){
  # SQL#4B
  echo "Mitigate #3 "
  echo "3. For Log Miner Dictionary File Created In DBA Directory, do not use UTL_FILE_DIR.
  UTL_FILE_DIR parameter should set to NULL
  " > mitigate_2332_3.sql
}

mitigate_2332_4(){
  val1=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0
  select filename from v\$logmnr_dictionary;
EOM
  )
   if [ "${val1}" > 0  ]
    then
      echo "Check the following PATH is set in DBA_DIRECTORIES and not in UTL_FILE_DIR parameter.
      For 19c Database, UTL_FILE_DIR has been deprecated.
      " > mitigate_2332_3.sql
      echo "${val1}" >>mitigate_2332_3.sql
    fi
}

mitigate_2332_5(){
  # SQL#5
  echo "Mitigate #5 "
  echo "
  If Log miner is not being used, ensure Log Miner is stopped in the database.
  Stop Log Miner process:
  BEGIN
    DBMS_LOGMNR.end_logmnr;
  END;
  " > mitigate_2332_4.sql
}

### main ###

discover_2332_1
discover_2332_2
discover_2332_3
discover_2332_4

discover_2332_1_return=$?
discover_2332_2_return=$?
discover_2332_3_return=$?
discover_2332_4_return=$?

if [ "$discover_2332_1_return" = 1 ] || [ "$discover_2332_2_return" = 1 ]
then
   mitigate_2332_1
   mitigate_2332_2
fi

if [ "$discover_2332_3_return" = 1 ]
then
   mitigate_2332_3
   mitigate_2332_4
fi

if [ "$discover_2332_4_return" = 1 ]
then
   mitigate_2332_5

fi

### main ###
