#!/usr/bin/bash
#. ./oracle_param.ini
################################################################################
#                              CVE-2021-35551
#                         12.1.0.2, 12.2.0.1, 19c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2021-35551.sh
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################

# export ORACLE_BASE=/u01/app/oracle
# export ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# export ORACLE_SID=orclcdb
# export SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus
# export ORACLE_HOME=$PATH:$ORACLE_HOM/bin

discover_35551_1(){
discover_35551_1_return=0
 val2=`grep -ioh "tcp.validnode_checking" $ORACLE_HOME/network/admin/sqlnet.ora`
 #echo "${val2}"
  if [ "${val2}" = "tcp.validnode_checking" ]
  then
    discover_35551_1_return=1
   else
    discover_35551_1_return=0
  fi
  return "$discover_35551_1_return"
}

discover_35551_2(){
discover_35551_2_return=0
 val2=`grep -ioh "tcp.invited_nodes" $ORACLE_HOME/network/admin/sqlnet.ora`
 #echo "${val2}"
  if [ "${val2}" = "tcp.invited_nodes" ]
  then
    discover_35551_2_return=1
   else
    discover_35551_2_return=0
  fi
  return "$discover_35551_2_return"
}

discover_35551_3(){
#SQL 4
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT UPPER(VALUE) "PARAMETER" FROM V\$PARAMETER WHERE UPPER(NAME) = 'REMOTE_LOGIN_PASSWORDFILE';
EOM
)
 if [[ ${val1} == *"SHARED"* ]]
 then
  discover_35551_3_return=1
 else
  discover_35551_3_return=0
  # It should be NONE or EXCLUSIVE  https://docs.oracle.com/database/121/REFRN/GUID-6619299E-95E8-4821-B123-3B5899F046C7.htm#REFRN10184
 fi
  return "$discover_35551_3_return"
}

discover_35551_4(){
#SQL 4
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select username from v\$pwfile_users;
EOM
)
 if [[ ${val1} == *"SHARED"* ]]
 then
  discover_35551_4_return=1
 else
  discover_35551_4_return=0
  # It should be NONE or EXCLUSIVE  https://docs.oracle.com/database/121/REFRN/GUID-6619299E-95E8-4821-B123-3B5899F046C7.htm#REFRN10184
 fi
  return "$discover_35551_4_return"
}

### main ###
ver=$(sqlplus -s / as sysdba <<EOM
      set heading OFF termout ON trimout ON feedback OFF
      set pagesize 0
      select version from v\$instance;
EOM
     )


case $ver in
    '19.0.0.0.0'|'12.0.0.0.0')
          discover_35551_1
          discover_35551_2

          discover_35551_1_return=$?
          discover_35551_2_return=$?

          if [ "$discover_35551_1_return" = 0 ] || [ "$discover_35551_2_return" = 0 ]
          then
             mitigate_35551_1
          fi
          ;;
      *)
           echo "Incompatible Oracle Version"
           ;;
esac

### main ###
