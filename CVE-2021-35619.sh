#!/usr/bin/bash
#. ./oracle_param.ini
################################################################################
#                       CVE-2021-35619
#                   12.1.0.2, 12.2.0.1, 19c, 21c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2020-27193
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################
# ORACLE_BASE=/u01/app/oracle
# ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# OACLE_SID=orclcdb
# SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus


# ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE')

discover_35619_1(){
#SQL 1
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT comp_name FROM dba_registry where upper(comp_name) like '%JAVA%';
EOM
)
  #echo "${val1}"
  if [[ ${val1} == *"JAVA"* ]]
   then
     discover_35619_1_return=1
    else
      discover_35619_1_return=0
   fi
   return "$discover_35619_1_return"
}

discover_35619_2(){
#SQL 2
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select detected_usages from DBA_FEATURE_USAGE_STATISTICS where name like '%Java%';
EOM
)
 if [ ${#val1} > 0 ]
 then
  #echo "${val1}"
  discover_35619_2_return=1
 else
  discover_35619_2_return=0
 fi
  return "$discover_35619_2_return"
}


discover_35619_3(){
#SQL 3
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE' and grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
EOM
)
 if [ ${#val1} > 0 ]
 then
  discover_35619_3_return=1
 else
  discover_35619_3_return=0
 fi
  return "$discover_35619_3_return"
}

discover_35619_4(){
#SQL 4
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT distinct GRANTEE FROM dba_java_policy where grantee IN (SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE') and grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
EOM
)
 if [ ${#val1} > 0 ]
 then
  discover_35619_4_return=1
 else
  discover_35619_4_return=0
 fi
  return "$discover_35619_4_return"
}

### Mitigate functions
mitigate_35619_1(){
  # SQL#5
  echo "Mitigate #1 "
  echo "1. Ensure that any users with the exploit privilege 'CREATE PROCEDURE' cannot delegate it to other users and those assigned are authorized to have this privilege assignment. "
  echo "commands in sql file mitigate_35619_1.sql"
  echo "Please review mitigate_35619_1.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_1.sql
         SELECT 'REVOKE CREATE PROCEDURE FROM '|| GRANTEE ||';' FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE' AND grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
         SELECT 'REVOKE CREATE PROCEDURE FROM '|| USERNAME ||';' from dba_users where PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE') and USERNAME in (SELECT distinct GRANTEE FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE IN (SELECT ROLE FROM ROLE_SYS_PRIVS WHERE PRIVILEGE='CREATE PROCEDURE'));
         spool off;
EOM
}

mitigate_35619_2(){
  # SQL#6.
  echo "Mitigate #2 "
  echo "2. Each user or schema must be assigned the proper permissions to access operating system resources,"
  echo "such as sockets, files, and system properties to load and run Java in the database."
  echo "DBA_JAVA_POLICY describes Java security permissions for all users in the database."
  echo "Following SQL Return Java Permissions (such as java.net.SocketPermission) Assigned to Users With Host/Port Details. These should be AUDIT. "
  echo "Please review mitigate_35619_2.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_2.sql
         select trim(TYPE_NAME)||' -- '||trim(NAME)||' -- '||trim(action) "Perm. granted to User/Role" from dba_java_policy where grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
         spool off;
EOM
}

mitigate_35619_3(){
  # SQL#7, SQL#7B
  echo "Mitigate #3"
  echo "3. Remove permissions to unauthorized users. In order to remove a Java permission from the database, it must first be disabled using the dbms_java.revoke_permission procedure. "
  echo "Then the permissions can be removed via the REVOKE PERMISSION and DELETE_PERMISSION procedure of the DBMS_JAVA package to remove or DROP a particular permission from the database. "
  echo "please review commands in sql file mitigate_35619_3.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_3.sql
         select 'execute dbms_java.revoke_permission ('''||user || ''',''' || name ||''',''' || action ||''','''|| enabled || ''');' from dba_java_policy where grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT'));
         select 'execute dbms_java.DELETE_PERMISSION ('''||seq || ''');' from dba_java_policy where grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
         spool off;
EOM
}

mitigate_35619_4(){
  # SQL#8
  echo "Mitigate #4 "
  echo "4. To ensure Java security in the database meets security framework standards and escalation of privileges cannot be performed outside of administrator control. "
  echo "Ensure 'EXECUTE' is revoked from 'PUBLIC' on Java Packages.  "
  echo "please review commands in sql file mitigate_35619_4.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_4.sql
         SELECT 'REVOKE '|| PRIVILEGE ||' ON ' || TABLE_NAME||' FROM ' || GRANTEE || ';'  FROM DBA_TAB_PRIVS WHERE GRANTEE='PUBLIC' AND PRIVILEGE='EXECUTE' AND TABLE_NAME IN ('DBMS_JAVA','DBMS_JAVA_TEST');
         spool off;
EOM
}

mitigate_35619_5(){
  # SQL#9, #9B
  echo " "
  echo "Mitigate #5"
  echo "5. Ensure membership of the JAVASYSPRIV and DEBUG roles is revoked from unauthorized 'GRANTEE'. "
  echo "SQL could be used to identify accounts "
  echo "please review commands in sql file mitigate_35619_5.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_5.sql
         SELECT 'REVOKE '|| GRANTED_ROLE ||' FROM ' || GRANTEE || ';'  FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE IN ('JAVASYSPRIV','JAVADEBUGPRIV','JAVAUSERPRIV','JAVA_ADMIN','JAVA_DEPLOY','JAVAIDPRIV','DBJAVASCRIPT') AND grantee IN (SELECT USERNAME FROM DBA_USERS WHERE PROFILE NOT IN ('DBS_SERVICES_PROFILE','SYSTEM_ACCOUNTS','DEFAULT','C##SYSTEM_ACCOUNTS','C##DBS_SERVICES_PROFILE'));
         spool off;
EOM
}

mitigate_35619_6(){
  # SQL#10
  val1=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0
  SELECT OS_USERNAME FROM SYS.JAVA\$RUNTIME\$EXEC\$USER\$ WHERE OWNER#=0;
EOM
)
   if [ ${#val1} > 0 ]
   then
     #SQL #10B
    echo " "
    echo "Mitigate #6"
    echo "6. Please review commands in sql file mitigate_35619_6.sql"
    echo "Ensure OS User is low privileged OS user and not Oracle/Application owner," > mitigate_35619_6.sql
    echo "and ensure secure Use of Runtime.exec Functionality in Oracle Database. " >> mitigate_35619_6.sql
    echo "Reference: https://docs.oracle.com/database/121/JJDEV/chten.htm#JJDEV13638" >> mitigate_35619_6.sql
    echo "EXEC DBMS_JAVA.SET_RUNTIME_EXEC_CREDENTIALS('<username>','<password>');" >> mitigate_35619_6.sql
   fi

  # SQL#11
  val2=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0
  SELECT DISTINCT 'EXEC DBMS_JAVA.REVOKE_PERMISSION (''' || GRANTEE || ''',''java.io.FilePermission'', ''<<ALL FILES>>'',''execute'');' FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.io.FilePermission' AND ACTION LIKE '%execute%' AND (NAME='<<ALL FILES>>' OR NAME LIKE '%*%') AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'JAVASYSPRIV';
EOM
)
   if [ ${#val2} > 0 ]
   then
    #SQL 11B
    echo " " >> mitigate_35619_6.sql
    echo "revoke Execute All Files Permissions from Unauthorized users"     >> mitigate_35619_6.sql
    echo "${val2}" >> mitigate_35619_6.sql
    echo " " >> mitigate_35619_6.sql
  else
    echo "No user is has granted java.io.FilePermission.execute other then JAVASYSPRIV."
   fi

   # SQL#12
   val3=$(sqlplus -s / as sysdba<<EOM
   set heading OFF termout ON trimout ON feedback OFF
   set pagesize 0
   SELECT DISTINCT 'EXEC DBMS_JAVA.REVOKE_PERMISSION (''' || GRANTEE || ''',''java.security.AllPermission'');' FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.security.AllPermission' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'SYS';
EOM
)
    if [ ${#val3} > 0 ]
    then
      #SQL 12B
      echo " " >> mitigate_35619_6.sql
      echo "revoke AllPermission from Unauthorized users." >> mitigate_35619_6.sql
      echo "${val3}" >> mitigate_35619_6.sql
      echo " " >> mitigate_35619_6.sql
   else
     echo "No user has java.security.AllPermission other then SYS."
    fi

   # SQL#13
    val4=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT DISTINCT 'EXEC DBMS_JAVA.REVOKE_PERMISSION (''' || GRANTEE || ''',''java.io.FilePermission'', ''<<ALL FILES>>'',''write'');' FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.io.FilePermission' AND ACTION LIKE '%write%' AND NAME='<<ALL FILES>>' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'JAVASYSPRIV';
EOM
)
    if [ ${#val4} > 0 ]
    then
     #SQL #13B
     echo " " >> mitigate_35619_6.sql
     echo "Ensure wildcard java.io.FilePermission.write is revoked from unauthorized 'GRANTEE'.  "  >> mitigate_35619_6.sql
     echo "${val4}" >> mitigate_35619_6.sql
     echo " " >> mitigate_35619_6.sql
   else
     echo "No user has java.io.FilePermission.write other then JAVASYSPRIV."
    fi

# SQL#14
    val5=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT DISTINCT 'EXEC DBMS_JAVA.DELETE_PERMISSION(' || seq || ');' FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.lang.RuntimePermission' AND NAME LIKE '%loadLibrary%' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE NOT IN ('SYS', 'ORDSYS');
EOM
)
     if [ ${#val5} > 0 ]
     then
      # SQL #14B
      echo " " >> mitigate_35619_6.sql
      echo "revoke Java Load Library permission by SEQ number" >> mitigate_35619_6.sql
      echo "${val5}" >> mitigate_35619_6.sql
      echo " " >> mitigate_35619_6.sql
    else
      echo "No user has java.lang.RuntimePermission.loadLibrary other then SYS, ORDSYS."
     fi

# SQL#15
    val6=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT 'REVOKE '||  PRIVILEGE || 'ON JAVA\$POLICY\$ FROM ' || GRANTEE || ';' FROM DBA_TAB_PRIVS WHERE TABLE_NAME like 'JAVA\$POLICY\$';
EOM
)
    if [ ${#val6} > 0 ]
    then
     # SQL #15B
     echo " " >> mitigate_35619_6.sql
     echo "Ensure "ALL" Is Revoked from Unauthorized "GRANTEE" on database sensitive objects." >> mitigate_35619_6.sql
     echo "${val6}" >> mitigate_35619_6.sql
     echo " " >> mitigate_35619_6.sql
   else
     echo "No user has privilege on JAVA$POLICY$."
    fi
}

### main ###
### main ###
ver=$(sqlplus -s / as sysdba <<EOM
      set heading OFF termout ON trimout ON feedback OFF
      set pagesize 0
      select version from v\$instance;
EOM
     )


discover_35619_1_return=$?
discover_35619_2_return=$?
discover_35619_3_return=$?
discover_35619_4_return=$?

discover_35619_1
discover_35619_2
discover_35619_3
discover_35619_4

if [ "$discover_35619_1_return" == 1 ] || [ "$discover_35619_2_return" == 1 ]
then
   mitigate_35619_1
   mitigate_35619_2
   mitigate_35619_3
   mitigate_35619_4
   mitigate_35619_5
fi

if [ "$discover_35619_3_return" == 1 ] || [ "$discover_35619_4_return" == 1 ]
then
   mitigate_35619_6
fi
### main ###
