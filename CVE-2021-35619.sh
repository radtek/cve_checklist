#!/usr/bin/bash
. ./oracle_param.ini
################################################################################
#                       CVE-2021-35619
#                   12.1.0.2, 12.2.0.1, 19c, 21c
# Sample script that checks the DB version and execute a check following
# by recommendation.
# Create oracle_param.ini file with defined variables
# Both script and ini required to have u+x permission
# Sample exection
# $./CVE-2020-27193
#
# Change History
# 15/10/2021  Deepak Baranwal  Original code. This is a template for creating
#                              new Bash shell scripts.
#                              Add new history entries as needed.
#
#
################################################################################
################################################################################
# ORACLE_BASE=/u01/app/oracle
# ORACLE_HOME=/u01/app/oracle/product/18.4.0/db_1
# OACLE_SID=orclcdb
# SQLPLUS_HOME=/u01/app/oracle/product/18.4.0/db_1/bin/sqlplus

discover_35619_1(){
#SQL 1
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT   comp_name FROM dba_registry where upper(comp_name) like '%JAVA%';
EOM
)
  #echo "${val1}"
  if [[ ${val1} == *"JAVA"* ]]
   then
     discover_35619_1_return=1
    else
      discover_35619_1_return=0
   fi
   return "$discover_35619_1_return"
}

discover_35619_2(){
#SQL 2
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
select  detected_usages from DBA_FEATURE_USAGE_STATISTICS where name like '%Java%';
EOM
)
 if [ ${#val1} > 0 ]
 then
  #echo "${val1}"
  discover_35619_2_return=1
 else
  discover_35619_2_return=0
 fi
  return "$discover_35619_2_return"
}


discover_35619_3(){
#SQL 3
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE' and GRANTEE NOT IN ('DBA','SYS','SYSTEM','DBSNMP','DV_REALM_RESOURCE','RECOVERY_CATALOG_OWNER','DVF','RESOURCE','MDSYS');
EOM
)
 if [ ${#val1} > 0 ]
 then
  #echo "Following users have CREATE PROCEDURE privileges, if not necessary please revoke."
  #echo "Users/ Roles other than 'DBA','SYS','SYSTEM','DBSNMP','DV_REALM_RESOURCE','RECOVERY_CATALOG_OWNER','DVF','RESOURCE','MDSYS'"
  #echo "${val1}"
  discover_35619_3_return=1
 else
  discover_35619_3_return=0
 fi
  return "$discover_35619_3_return"
}

discover_35619_4(){
#SQL 4
val1=$(sqlplus -s / as sysdba<<EOM
set heading OFF termout ON trimout ON feedback OFF
set pagesize 0
SELECT distinct GRANTEE FROM dba_java_policy where grantee IN (SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE');
EOM
)
 if [ ${#val1} > 0 ]
 then
  #echo "Following users have JAVA Execution privileges, if not necessary please revoke."
  #echo "Users/ Roles other than 'SYS','SYSTEM','MDSYS','JAVASYSPRIV','DBJAVASCRIPT','JMXSERVER','PUBLIC','JAVA_ADMIN','JAVAUSERPRIV','EJBCLIENT','JAVADEBUGPRIV','ORDSYS'"
  #echo "${val1}"
  discover_35619_4_return=1
 else
  discover_35619_4_return=0
 fi
  return "$discover_35619_4_return"
}



mitigate_35619_1(){
  # SQL#5
  echo " "
  echo "Ensure that any users with the exploit privilege 'CREATE PROCEDURE' cannot delegate it to other users and those assigned are authorized to have this privilege assignment. "
  echo "commands in sql file mitigate_35619_1.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_1.sql
         SELECT 'REVOKE CREATE PROCEDURE FROM '|| GRANTEE ||';' FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE' AND GRANTEE NOT IN ('DBA','SYS','SYSTEM','DBSNMP','DV_REALM_RESOURCE','RECOVERY_CATALOG_OWNER','DVF','RESOURCE','MDSYS');
         spool off;
EOM
}

mitigate_35619_2(){
  # SQL#6.
  echo " "
  echo "Each user or schema must be assigned the proper permissions to access operating system resources,"
  echo "such as sockets, files, and system properties to load and run Java in the database."
  echo "DBA_JAVA_POLICY describes Java security permissions for all users in the database."
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_1.sql
         select trim(TYPE_NAME)||' -- '||trim(NAME)||' -- '||trim(action) "Perm. granted to User/Role" from dba_java_policy where grantee  in (SELECT GRANTEE FROM DBA_SYS_PRIVS WHERE PRIVILEGE = 'CREATE PROCEDURE');
         spool off;
EOM
}

mitigate_35619_3(){
  # SQL#7, SQL#7B
  echo " "
  echo "Remove permissions to unauthorized users. In order to remove a Java permission from the database, it must first be disabled using the dbms_java.revoke_permission procedure. "
  echo "Then the permissions can be removed via the REVOKE PERMISSION and DELETE_PERMISSION procedure of the DBMS_JAVA package to remove or DROP a particular permission from the database. "
  echo "commands in sql file mitigate_35619_3.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_3.sql
         select 'execute dbms_java.revoke_permission ('''||user || ''',''' || name ||''',''' || action ||''','''|| enabled || ''');' from dba_java_policy where grantee NOT IN ('SYS','SYSTEM','MDSYS','JAVASYSPRIV','DBJAVASCRIPT','JMXSERVER','PUBLIC','JAVA_ADMIN','JAVAUSERPRIV','EJBCLIENT','JAVADEBUGPRIV','ORDSYS');
         select 'execute dbms_java.DELETE_PERMISSION ('''||seq || ''');' from dba_java_policy where grantee NOT IN ('SYS','SYSTEM','MDSYS','JAVASYSPRIV','DBJAVASCRIPT','JMXSERVER','PUBLIC','JAVA_ADMIN','JAVAUSERPRIV','EJBCLIENT','JAVADEBUGPRIV','ORDSYS');
         spool off;
EOM
}

mitigate_35619_4(){
  # SQL#8
  echo " "
  echo "To ensure Java security in the database meets security framework standards and escalation of privileges cannot be performed outside of administrator control. "
  echo "Ensure 'EXECUTE' is revoked from 'PUBLIC' on "Java" Packages.  "
  echo "commands in sql file mitigate_35619_4.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_4.sql
         SELECT 'REVOKE '|| PRIVILEGE ||' ON ' || TABLE_NAME||' FROM ' || GRANTEE || ';'  FROM DBA_TAB_PRIVS WHERE GRANTEE='PUBLIC' AND PRIVILEGE='EXECUTE' AND TABLE_NAME IN ('DBMS_JAVA','DBMS_JAVA_TEST');
         spool off;
EOM
}

mitigate_35619_5(){
  # SQL#9.
  echo " "
  echo "Ensure membership of the JAVASYSPRIV and DEBUG roles is revoked from unauthorized 'GRANTEE'"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_2.sql
         SELECT distinct GRANTEE FROM dba_java_policy WHERE GRANTEE NOT IN ('SYS','SYSTEM','MDSYS','JAVASYSPRIV','DBJAVASCRIPT','JMXSERVER','PUBLIC','JAVA_ADMIN','JAVAUSERPRIV','EJBCLIENT','JAVADEBUGPRIV','ORDSYS');
         spool off;
EOM
}

mitigate_35619_6(){
  # SQL#9B
  echo " "
  echo "Ensure membership of the JAVASYSPRIV and DEBUG roles is revoked from unauthorized 'GRANTEE'. "
  echo "SQL could be used to identify accounts "
  echo "commands in sql file mitigate_35619_5.sql"
  sqlplus -s / as sysdba<<EOM
         set heading OFF termout ON trimout ON feedback OFF
         set pagesize 0
         spool mitigate_35619_5.sql
         SELECT 'REVOKE '|| GRANTED_ROLE ||' FROM ' || GRANTEE || ';'  FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE IN ('JAVASYSPRIV','JAVADEBUGPRIV','JAVAUSERPRIV','JAVA_ADMIN','JAVA_DEPLOY','JAVAIDPRIV','DBJAVASCRIPT') AND GRANTEE NOT IN('SYS','DBA','OWBSYS','XDB','JAVA_ADMIN');
         spool off;
EOM
}

mitigate_35619_7(){
  # SQL#10
  val1=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0
  SELECT OS_USERNAME FROM SYS.JAVA\$RUNTIME\$EXEC\$USER\$ WHERE OWNER#=0;
EOM
)
   if [ ${#val1} > 0 ]
   then
    echo " Ensure OS User is low privileged OS user and not Oracle/Application owner," > mitigate_35619_7.sql
    echo "and ensure secure Use of Runtime.exec Functionality in Oracle Database. " >> mitigate_35619_7.sql
    echo "Reference: https://docs.oracle.com/database/121/JJDEV/chten.htm#JJDEV13638" >> mitigate_35619_7.sql
    echo "EXEC DBMS_JAVA.SET_RUNTIME_EXEC_CREDENTIALS('<username>','<password>');" >> mitigate_35619_7.sql
   fi

  # SQL#12
  val2=$(sqlplus -s / as sysdba<<EOM
  set heading OFF termout ON trimout ON feedback OFF
  set pagesize 0
  SELECT GRANTEE FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.io.FilePermission' AND ACTION LIKE '%execute%' AND (NAME='<<ALL FILES>>' OR NAME LIKE '%*%') AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'JAVASYSPRIV';
EOM
)
   if [ ${#val2} > 0 ]
   then
    echo "Ensure java.io.FilePermission.execute is revoked from unauthorized 'GRANTEE' ."
    echo "${val2}"
  else
    echo "No user is has granted java.io.FilePermission.execute other then JAVASYSPRIV."
   fi

   # SQL#13
   val3=$(sqlplus -s / as sysdba<<EOM
   set heading OFF termout ON trimout ON feedback OFF
   set pagesize 0
   SELECT GRANTEE FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.security.AllPermission' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'SYS';
EOM
)
    if [ ${#val3} > 0 ]
    then
     echo "Ensure java.security.All Permission is revoked from unauthorized 'GRANTEE'.  "
     echo "${val3}"
   else
     echo "No user has java.security.AllPermission other then SYS."
    fi

   # SQL#14
    val4=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT GRANTEE FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.io.FilePermission' AND ACTION LIKE '%write%' AND NAME='<<ALL FILES>>' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE != 'JAVASYSPRIV';
EOM
)
    if [ ${#val4} > 0 ]
    then
     echo "Ensure wildcard java.io.FilePermission.write is revoked from unauthorized 'GRANTEE'."
     echo "${val4}"
   else
     echo "No user has java.io.FilePermission.write other then JAVASYSPRIV."
    fi

# SQL#15
    val5=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT GRANTEE FROM DBA_JAVA_POLICY WHERE TYPE_NAME = 'java.lang.RuntimePermission' AND NAME LIKE '%loadLibrary%' AND KIND = 'GRANT' AND ENABLED='ENABLED' AND GRANTEE NOT IN ('SYS', 'ORDSYS');
EOM
)
     if [ ${#val5} > 0 ]
     then
      echo "Ensure java.lang.RuntimePermission.loadLibrary is revoked from unauthorized 'GRANTEE'."
      echo "${val5}"
    else
      echo "No user has java.lang.RuntimePermission.loadLibrary other then SYS, ORDSYS."
     fi

# SQL#16
    val6=$(sqlplus -s / as sysdba<<EOM
    set heading OFF termout ON trimout ON feedback OFF
    set pagesize 0
    SELECT GRANTEE FROM DBA_TAB_PRIVS WHERE TABLE_NAME = 'JAVA\$POLICY\$';
EOM
)
    if [ ${#val6} > 0 ]
    then
     echo "Ensure "ALL" Is Revoked from Unauthorized "GRANTEE" on database sensitive objects."
     echo "${val6}"
   else
     echo "No user has privilege on JAVA$POLICY$."
    fi
}

### main ###
case $ver in
 '19.0.0.0.0'|'12.0.0.0.0'|'21.0.0.0.0')
      discover_35619_1_return=$?
      discover_35619_2_return=$?
      discover_35619_3_return=$?
      discover_35619_4_return=$?

      discover_35619_1
      discover_35619_2
      discover_35619_3
      discover_35619_4

      if [ "$discover_35619_1_return" == 1 ] || [ "$discover_35619_2_return" == 1 ]
      then
         mitigate_35619_1
         mitigate_35619_2
         mitigate_35619_3
         mitigate_35619_4
         mitigate_35619_5
      fi

      if [ "$discover_35619_3_return" == 1 ] || [ "$discover_35619_4_return" == 1 ]
      then
         mitigate_35619_6
      fi
      ;;
  *)
       echo "Incompatible Oracle Version"
       ;;
esac
### main ###
